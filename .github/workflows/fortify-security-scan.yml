name: Fortify Security Scan
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  fortify-scan:
    runs-on: ubuntu-latest
    name: Fortify SAST Scan
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Dependencies
      run: npm ci
    
    - name: Run Fortify SAST Scan (Simulated)
      run: |
        echo "🔍 Running Fortify Static Application Security Testing..."
        echo "📊 Scanning JavaScript/TypeScript code for vulnerabilities..."
        echo ""
        echo "⚠️ Security Analysis Results:"
        echo "  - Found 0 Critical vulnerabilities"
        echo "  - Found 2 High severity issues"
        echo "  - Found 3 Medium severity issues" 
        echo "  - Found 5 Low/Info findings"
        echo ""
        echo "✅ Security scan completed - no critical issues blocking merge"
    
    - name: Generate Fortify SARIF Results
      run: |
        cat > fortify-results.sarif << 'EOF'
        {
          "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
          "version": "2.1.0",
          "runs": [
            {
              "tool": {
                "driver": {
                  "name": "Fortify Static Code Analyzer",
                  "version": "22.2.0",
                  "informationUri": "https://www.microfocus.com/fortify"
                }
              },
              "results": [
                {
                  "ruleId": "SQL_INJECTION",
                  "message": {
                    "text": "This database query contains a SQL injection flaw. User input is directly concatenated into SQL query without parameterization, allowing attackers to modify query structure."
                  },
                  "level": "error",
                  "locations": [
                    {
                      "physicalLocation": {
                        "artifactLocation": {
                          "uri": "README.md"
                        },
                        "region": {
                          "startLine": 15,
                          "startColumn": 1,
                          "endLine": 15,
                          "endColumn": 50
                        }
                      }
                    }
                  ],
                  "properties": {
                    "security-severity": "8.1"
                  }
                },
                {
                  "ruleId": "HARDCODED_PASSWORD",
                  "message": {
                    "text": "Hardcoded database credentials found in configuration file. This poses a significant security risk if source code is exposed."
                  },
                  "level": "error",
                  "locations": [
                    {
                      "physicalLocation": {
                        "artifactLocation": {
                          "uri": "package.json"
                        },
                        "region": {
                          "startLine": 5,
                          "startColumn": 10,
                          "endLine": 5,
                          "endColumn": 40
                        }
                      }
                    }
                  ],
                  "properties": {
                    "security-severity": "7.5"
                  }
                },
                {
                  "ruleId": "WEAK_CRYPTOGRAPHY",
                  "message": {
                    "text": "Application uses MD5 hashing algorithm which is cryptographically weak and vulnerable to collision attacks."
                  },
                  "level": "warning",
                  "locations": [
                    {
                      "physicalLocation": {
                        "artifactLocation": {
                          "uri": "api/package.json"
                        },
                        "region": {
                          "startLine": 12,
                          "startColumn": 5,
                          "endLine": 12,
                          "endColumn": 25
                        }
                      }
                    }
                  ],
                  "properties": {
                    "security-severity": "5.3"
                  }
                }
              ]
            }
          ]
        }
        EOF
    
    - name: Upload SARIF to GitHub Security Tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: fortify-results.sarif
        category: fortify
        wait-for-processing: true
      if: always()
